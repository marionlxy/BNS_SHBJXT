<div class="widget-box widget-color-blue">
	<div class="widget-header clearfix">
		<!-- <h5 class="widget-title">代码类别</h5> -->
		<!-- <div class="widget-toolbar">
			<a href="#" data-action="fullscreen" class="blue"> <i
				class="ace-icon fa fa-expand"></i>
			</a>
		</div> -->
	</div>

	<div class="widget-body">
		<div class="widget-main padding-8">
			<div class="row">
				<div class="col-sm-4">
					<a id='newAddTree' class="btn btn-purple btn-xs" href="javascript:void(0);">
					<i class="ace-icon fa fa-plus-circle bigger-130"></i>
					<span>增加代码组</span>
					</a>
					<a id='newUpdateTree' class="btn btn-purple btn-xs" href="javascript:void(0);">
		                <i class="ace-icon fa fa-pencil-square bigger-130"></i>
		                <span>修改代码组</span>
		            </a>
					<a id ="newDelTree" class="btn btn-purple btn-xs" href="javascript:void(0);">
		                <i class="ace-icon fa fa-pencil-square bigger-130"></i>
		                <span>删除代码组</span>
		            </a>
		            <hr>
					<div>
						<ul id="treeMenu" class="ztree"></ul>
					</div>
				</div>
				<div class="col-sm-8" id="list-page">
					<div id=""  class="perPassShow" style="text-align: right">
					<a id='newAdd' class="btn btn-purple btn-xs" href="javascript:void(0);">
					<i class="ace-icon fa fa-plus-circle bigger-130"></i>
					<span>新增</span>
					</a>
					<a id='newUpdate' class="btn btn-purple btn-xs" href="javascript:void(0);">
		                <i class="ace-icon fa fa-pencil-square bigger-130"></i>
		                <span>修改</span>
		            </a>
					<a id ="delCode" class="btn btn-purple btn-xs" href="javascript:void(0);">
		                <i class="ace-icon fa fa-pencil-square bigger-130"></i>
		                <span>删除</span>
		            </a>
					</div>
					<div id="widget-box" class="widget-box" style="margin-top:50px;">
				    <div class="form-inline" role="form" >
				    	<div class="form-group">
						&nbsp;&nbsp;<span>数据源反射类地址:</span>
						<input id="showDataSource" name="perPass"  value="" style="width:550px;" class="form-control w150" type="text"  disabled="true">
						</div>
					</div>
					</div>
				<div class="perPassShow"> 
					<table id="tableCode"  data-toolbar="#toolbar" 	data-toolbar-align="right">
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
</div>

<SCRIPT LANGUAGE="JavaScript">



   // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
   var setting = {
		   async:{  
		         enable:true,  
		         url:"${ctxPath!}/pt/bascodegroup/ajaxCode",  
		         autoParam:"id",  
		         dataType:"json",  
		        },
			view:{
				expandSpeed:100,
				selectedMulti : false,
				fontCss:function(treeId, treeNode) {
					return (!!treeNode.highlight) ? {"font-weight":"bold","color":"red"} : {"font-weight":"normal","color":"#333"};
				}
			},
			edit: {
				enable: false
			},
			data : {
				simpleData : {
					enable : true,
					idKey : "id",
					pIdKey :"parentId",
					rootPId: 0
				},
				key:{
					name:"codeGroupName"
				}
			},
			callback: {
				onClick: onClickNode
			}
		};

   
	var zNodes;
	var zTreeObj; //获取初始化树对象
	var root;
	function initTreeType(zNodes){
			// zTree 的数据属性，深入使用请参考 API 文档（zTreeNode 节点数据详解）
			zTreeObj  = $.fn.zTree.init($("#treeMenu"), setting, zNodes);
			return zTreeObj;
	}
	
		 /** 
		  * 刷新当前根节点
		  */ 
	function refreshParentNode(id){ 
		 //var snode=zTreeObj.getSelectedNodes();
		 var root=zTreeObj.getNodeByParam("id",0, null);
		 zTreeObj.reAsyncChildNodes(root , "refresh");
		 var nodes = zTreeObj.getNodes();  
		 zTreeObj.expandNode(nodes[0], true); 
		//alert(3);
		 //zTreeObj.selectNode(node);
		} 
	
	/*新增树节点*/
	$("#newAddTree").click(function(){
		 var snode=zTreeObj.getSelectedNodes();
		 if(snode==null||snode.length<1){
			 layer.alert("当前没有选中节点！");//
			 return false;
		 }
		 var id=snode[0].id;
		 if(snode[0].id!=0){
			 layer.alert("必须选择根节点"+ "["+root['codeGroupName']+"]"+"新增!");//
			 return false;
		 }
		//alert(id);
		if(id!=null){
			$.cuslayer(
					{
					mode:"page",
					url:"${ctxPath!}/pt/bascodegroup/toAddBasCodeGroup",
					height:'65%',
					width:'50%',
					data:{'id':id},
					title:'添加代码'
					}
			);
		}
	})
	
		/*修改树节点*/
	$("#newUpdateTree").click(function(){
		 var snode=zTreeObj.getSelectedNodes();
		 if(snode==null||snode.length<1){
			 layer.alert("当前没有选中节点！");//
			 return false;
		 }
		 var id=snode[0].id;
		 if(snode[0].id==0){
			 layer.alert("请选择子节点进行修改");//
			 return false;
		 }
		//alert(id);
		if(id!=null){
			$.cuslayer(
					{
					mode:"page",
					url:"${ctxPath!}/pt/bascodegroup/toEditBasCodeGroup",
					height:'65%',
					width:'50%',
					data:{'id':id},
					title:'修改节点'
					}
			);
		}
		
	})
	
			/*删除树节点*/
	$("#newDelTree").click(function(){
		 var snode=zTreeObj.getSelectedNodes();
		 if(snode==null||snode.length<1){
			 layer.alert("当前没有选中节点！");//
			 return false;
		 }
		 var id=snode[0].id;
		 if(snode[0].id==0){
			 layer.alert("请选择子节点进行删除");//
			 return false;
		 }
		layer.confirm('确定删除该代码组以及字典信息吗？',function(){
					  $.post("${ctxPath!}/pt/bascodegroup/removeBasCodeGroup",{'id':id},function(data){
						if(data.code==1){
							layer.msg("删除成功!",1,1);
							refreshParentNode(0);
							 $("#tableCode").bootstrapTable('refresh',{'url':'${ctxPath!}/pt/bascode/detailCode?'+'id='+id});
							 iniTable(id);
						}else{
							layer.msg("删除失败!");
						}
					},"json"); 
			
			});
	})
	
	/*树查询*/
 	$(function(){  
		   	$.ajax({  
		       async:false,  
		       cache:false,  
		       type: 'POST',  
		       dataType : "json",  
		       url:"${ctxPath!}/pt/bascodegroup/ajaxCode",//请求的action路径  
		       error: function () {//请求失败处理函数  
		    		layer.msg("未找到树！",3,1);  
		       },  
		       success:function(data){ //请求成功后处理函数。    
		           //var datajson=JSON.stringify(data);
		           //var datajson=jQuery.parseJSON(data)
		              //初始根节点
		            root = {open:true,isParent:true};
						   root['id'] = 0;
						   root['codeGroupName'] = "代码类别";	
		           if(data.length>0){
		        	   //alert(1);
		        	   zNodes=data;
					   zNodes.splice(0, 0, root); //添加一个根节点,根节点默认位0
						zTreeObj=initTreeType(zNodes);
		        	   		//根节点是0，已初始完成,在public.js
		        	     var nodes = zTreeObj.getNodes();
		        	     zTreeObj.selectNode(nodes[0].children[0]);
		        	     iniTable(zTreeObj.getSelectedNodes()[0].id); //data[1].id
		        	
		           }else{
		        	   //alert(2);
		        	   //初始根节点
						   zTreeObj=initTreeType(root);
						   var nodes = zTreeObj.getNodes();
						   zTreeObj.expandNode(nodes[0],true);
		        	   	   iniTable();
		           }
		       }  
   			}); 
 	});
  
	//节点点击事件
	function onClickNode(event, treeId, treeNode) {
			//paging(opts.form,1); //刷新表单
			var idKey=setting.data.simpleData.idKey;
			//console.log(treeId);
			//console.log(treeNode);
			//console.log('${ctxPath!}/pt/bascode/detailCode?'+idKey+'='+eval("treeNode."+idKey));
			//var queryUrl='${ctxPath!}/pt/bascode/detailCode?'+idKey+'='+treeNode.id;
			//先查询反射是否存在
			if(treeNode.id==0){
				return;
			}
			var queryUrl='${ctxPath!}/pt/bascode/detailCode?'+idKey+'='+treeNode.id
			var data=initAjaxReflect(queryUrl);//做了刷新操作和隐藏操作
			//alert(data);
		}

	
   

	 //获取选中节点
	function getchkedNode(){
		 var zTreeObj=$.fn.zTree.getZTreeObj("treeMenu");	
		 var snode=zTreeObj.getSelectedNodes();
		 if(snode==null||snode<1){
			 layer.alert("请单击选择右边一个节点");
			 return
		 }else if(snode[0].id==0){
			 layer.alert("不能选择根节点新增");
			 return
		 }
		 return snode[0].id;
		}
 //==========================
	function initAjaxReflect(queryUrl){
			var data;
		  $.post(queryUrl,function(result){
			  	data=result;
			  	//console.log(result);
				if(data!=null&&data.length==1&&data[0].pefPass!=null&&data[0].pefPass!=''){
					//layer.msg("找到相关数据!",1,1);
					//$("#showDataSource").html(data[0].pefPass);
					//flag=data.length;
					$(".perPassShow").hide();
					$("#showDataSource").val(data[0].pefPass);
					$("#widget-box").show();
					
				}else{
					//layer.msg("未找到数据!",3,1);
					$('#tableCode').bootstrapTable('refresh',{'url':queryUrl});
					$("#widget-box").hide();
					$(".perPassShow").show();
					//alert(3);
				}
			},"json"); 
		 return data;
 }
	 /*bootstrap表单相关*/
	 function iniTable(id){
		 var queryUrl = '${ctxPath!}/pt/bascode/detailCode?id='+id;
		 	//先查询反射是否存在
		 	initAjaxReflect(queryUrl);
		 
			 function formate(value, row, index) {
					return index + 1;
				};
			 
			 function formatV(value,row,index) {
					//alert(value);
					if (value == 0||value== '0') {
						return "是";
					} else {
						return "专有";
					}
				};
			
			function formaterchk(value,row,index) {
						//alert(value);
						if (row.sysFlag == 0||row.sysFlag== '0') {
							return {disabled:true,checked:true};
						} 
					}; 	
			 $("#tableCode").bootstrapTable({
					inconSize : 'sm',
					height:300,
					url : queryUrl,
					striped : true,
					singleSelect:true,
					columns : [ {
						checkbox : true,
						formatter :formaterchk
					},  
					{
						field : "id",
						title : '序号',
						formatter :formate
					}, {
						field : "ecode",
						title : '编码',
						sortable : true
					}, {
						field : "name",
						title : '名称',
						sortable : true
					}, {
						field : "mapName",
						title : '委员会名称',
						sortable : true
					}, {
						field : "enableCode",
						title : '启用阶段代码',
						sortable : true
					}, {
						field : "enableName",
						title : '启用阶段名称',
						sortable : true
					
					},{
						field : "sysFlag",
						title : '平台标志',
						sortable : true,
						formatter : formatV
					}],
					onPostBody:hiddenchk,
			           onRefresh:hiddenchk
			     });
			     //--------------隐藏----------------------------------
			     function hiddenchk() {
			            //alert(value);
			                $( "input[name='btSelectItem'][disabled='disabled']" ).attr("type" ,"hidden" );
			     };

 }
//=============================
	/*新增*/
	$("#newAdd").click(function(){
		
		var id=getchkedNode();//子节点cgid
		//alert(id);
		if(id!=null){
			$.cuslayer(
					{
					mode:"page",
					url:"${ctxPath!}/pt/bascode/toAddBasCode",
					height:'65%',
					width:'50%',
					data:{'id':id},
					title:'添加代码'
					}
			);
		}
	})
	/*修改*/
	$("#newUpdate").click(function(){
		var rows = $('#tableCode').bootstrapTable("getSelections");
		var newArr=[];
		$.each(rows,function(index,obj){
			if(obj.sysFlag==1){
				newArr.push(obj);
			}
		});
		if(newArr.length==0){
			layer.alert("请选择要操作的非平台数据");
			return;
		}else if(newArr.length>1){
			layer.alert("请选择一条数据进行非平台操作");
			return;
		}else{
			var row = newArr[0];
			var id= row.id;
			$.cuslayer(
					{
					mode:"page",
					url:"${ctxPath!}/pt/bascode/toEditBasCode",
					height:'65%',
					width:'50%',
					data:{'id':id},
					title:'添加代码'
					}
			);
		}
	});
	
	/*删除code信息*/
	$('#delCode').click(function(){
		var checks = $("#tableCode").bootstrapTable('getSelections');
		var newArr=[];
		if(checks.length==0){
			layer.alert("请选择要操作的数据");
			return;
		}else{
			$.each(checks,function(index,obj){
				if(obj.sysFlag==1){
					newArr.push(obj);
				}
			});
			if(newArr.length==0){
				layer.alert("请选择要操作的非平台数据");
			}else{
				layer.confirm('确定删除数据吗？',function(){
							for(var i=0;i<newArr.length;i++){
								var row = newArr[i];
								  $.post("${ctxPath!}/pt/bascode/removeBasCode",{'id':row.id},function(result){
									if(result.code==1){
										layer.msg("删除成功!",1,1);
										 $("#tableCode").bootstrapTable('refresh');
									}else{
										layer.msg("删除失败!");
									}
								},"json"); 
							} 
						});
			}
		}
	});
	  </SCRIPT>
 
 